<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../../../vendor/js/jquery.min.js-v=2.1.4.js"></script>
    <link rel="stylesheet" href="../../../vendor/css/style.min.css-v=4.0.0.css">
    <link href="../../../vendor/css/bootstrap.min.css-v=3.3.5.css" rel="stylesheet">
    <style>.right{ float: right;</style>
</head>
<body class="gray-bg">
    <div id="tree" class="wrapper wrapper-content row" >

        <div class="col-sm-4">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    选择镇/村/组
                    <button class="btn btn-xs btn-info right" id="back">返回上一级</button>
                </div>
                <div class="panel-body">

                    <div class="list-group " id="list">
                        <a href="#" class="list-group-item"> </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    添加或修改
                    <small class="right"></small>
                </div>
                <div class="panel-body">
                    <form class="form-horizontal" role="form">
                        <fieldset>
                            <legend contenteditable="true">添加县</legend>

                            <div class="form-group">
                                <label for="name" class="col-sm-2 control-label">县名: </label>
                                <div class="col-sm-10">
                                    <input id="name" class="form-control" name="name" type="text" placeholder="请输入县名" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="lat" class="col-sm-2 control-label">经度: </label>
                                <div class="col-sm-10">
                                    <input id="lat" class="form-control" name="lat" type="text" placeholder="请输入经度" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="name" class="col-sm-2 control-label">纬度: </label>
                                <div class="col-sm-10">
                                    <input id="lon" class="form-control" name="lon" type="text" placeholder="请输入纬度" />
                                </div>
                            </div>

                            <button class="btn btn-primary col-sm-offset-2" type="submit">提交</button>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function () {
            var tree = {
                towns: [],
                villages: [],
                groups: [],
                current: '',
                history: []
            };
            var url = {
                towns: "/unit/getVillagesByTown",
                villages: "/unit/getGroupsByVillage"
            };
            var getUserInfo = function () {
                var info = {
                    userId: window.sessionStorage.getItem('userId') || -1,
                    userName: window.sessionStorage.getItem('userName') || null,
                    token: window.sessionStorage.getItem('token') || 0,
                    rolesId: window.sessionStorage.getItem('rolesId') || -1,
                    rolesName: window.sessionStorage.getItem('rolesName') || -1,
                };
                return info;
            }
            var userInfo = getUserInfo();
            var data = {
                userId: userInfo.userId,
                token: userInfo.token
            };

            var renderList = function () {
                var data = tree[tree.current];
                var html = '';
                var extra = '<button class="btn btn-xs btn-info add" style="float: right;z-index: 10;">添加</button>' ;
                data.map(function (item) {
                    if (tree.current == 'groups') extra = '';
                    html += '<a class="list-group-item btn-toolbar" data-id="'+item.id+'">' +
                                item.name + extra +
                                '<button class="btn btn-xs btn-primary modify" style="float: right;z-index: 10;">修改</button>' +
                            '</a>';
                })
                tree.history.push($("#list").html() + '');
                $("#list").html(html);

                eventBind();
            }
            var eventBind = function () {
                var type = tree.current;
                var $list = $(".list-group-item");
                $list.click(function (e) {
                    e.preventDefault();
                    console.log(e.target);
                    if (tree.current === 'groups') return false;
                    var id = $(this).attr('id');
                    data[type.substr(0, type.length-1)] = id;
                    if (type == 'towns') tree.current = 'villages';
                    else tree.current = 'groups';
                    tree[tree.current] = [];
                    $.get(url[type], data, function (res) {
                        if (typeof res == 'string') res = JSON.parse(res);
                        if (res.code == 200) {
                            res.data[tree.current].map(function (item) {
                                tree[tree.current].push({
                                    name: item.name,
                                    id: item.id
                                })
                            })
                            renderList();
                        } else {
                            console.error("error with code", code);
                        }
                    })
                })

                var $add = $(".add");
                var $modify = $(".modify");
                $add.click(function (e) {
                    e.preventDefault();
                    // 添加 下一级
                    return false;
                })
                $modify.click(function (e) {
                    e.preventDefault();
                    // 修改 当前内容
                    return false;
                })
            }
            var getAccessedTowns = function () {
                $.get("/unit/getAccessedTowns", data, function (res) {
                    if (typeof res == 'string') res = JSON.parse(res);
                    if (res.code == 200) {
                        var townsList = res.data.towns;
                        townsList.map(function (item) {
                            tree.towns.push({
                                name: item.name,
                                id: item.id
                            });
                        })

                        tree.current = 'towns';
                        renderList();
                        /*return rootTree;*/
                    } else {
                        console.error("error with code", res.code);
                    }
                })
            };
            var back = function () {
                $("#back").click(function (e) {
                    e.preventDefault();
                    console.log('back');
                    if (!tree.current || tree.current == 'towns')
                        return false;
                    else {
                        if (tree.history.length > 0){
                            if (tree.current == 'groups') tree.current = 'villages';
                            else  tree.current = 'towns';
                            var history = tree.history.pop();
                            $("#list").html(history);

                            eventBind();
                        }
                    }
                })
            }

            getAccessedTowns();
            back();
        })
    </script>
</body>
</html>